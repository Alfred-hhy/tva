# TVA 核心概念图解

## 1. 秘密共享原理

### 1.1 复制秘密共享（3方协议）

```
原始秘密: x = 100

步骤1: 生成随机份额
┌─────────────────────────────────┐
│ x₀ = 30 (随机)                  │
│ x₁ = 25 (随机)                  │
│ x₂ = 100 - 30 - 25 = 45 (计算) │
└─────────────────────────────────┘

步骤2: 分发份额（每方持有2个份额）
┌─────────┬─────────┬─────────┐
│ Party 0 │ Party 1 │ Party 2 │
├─────────┼─────────┼─────────┤
│  x₀=30  │  x₁=25  │  x₂=45  │
│  x₁=25  │  x₂=45  │  x₀=30  │
└─────────┴─────────┴─────────┘

步骤3: 重构秘密（任意2方合作）
x = x₀ + x₁ + x₂ = 30 + 25 + 45 = 100 ✓
```

**安全性保证：**
- 单个参与方只知道2个份额，无法推断秘密
- 需要至少2方合作才能重构秘密
- 可以容忍1方是半诚实的

---

## 2. 算术共享 vs 布尔共享

### 2.1 算术共享

```
秘密: x = 100

算术共享: [x]ₐ
┌──────────────────────────────┐
│ x = x₀ + x₁ + x₂ (mod 2³²)  │
│ x = 30 + 25 + 45 = 100      │
└──────────────────────────────┘

适用操作:
✓ 加法: [x]ₐ + [y]ₐ = [x+y]ₐ  (本地)
✓ 减法: [x]ₐ - [y]ₐ = [x-y]ₐ  (本地)
✓ 乘法: [x]ₐ × [y]ₐ = [x×y]ₐ  (需要通信)
✗ 比较: 效率低
```

### 2.2 布尔共享

```
秘密: x = 100 (二进制: 01100100)

布尔共享: [x]ᵦ
┌──────────────────────────────┐
│ x = x₀ ⊕ x₁ ⊕ x₂            │
│ 每一位独立异或               │
└──────────────────────────────┘

适用操作:
✓ AND: [x]ᵦ ∧ [y]ᵦ = [x∧y]ᵦ  (需要通信)
✓ XOR: [x]ᵦ ⊕ [y]ᵦ = [x⊕y]ᵦ  (本地)
✓ 比较: [x]ᵦ > [y]ᵦ = [x>y]ᵦ  (需要通信)
✗ 乘法: 效率低
```

---

## 3. 安全计算流程

### 3.1 安全乘法示例

```
输入: x = 10, y = 20
目标: 计算 z = x × y = 200

┌─────────────────────────────────────────────────────────┐
│ 步骤1: 秘密共享输入                                      │
├─────────────────────────────────────────────────────────┤
│ Party 0: (x₀, x₁) = (3, 2)    (y₀, y₁) = (7, 5)       │
│ Party 1: (x₁, x₂) = (2, 5)    (y₁, y₂) = (5, 8)       │
│ Party 2: (x₂, x₀) = (5, 3)    (y₂, y₀) = (8, 7)       │
│                                                          │
│ 验证: x₀+x₁+x₂ = 3+2+5 = 10 ✓                          │
│       y₀+y₁+y₂ = 7+5+8 = 20 ✓                          │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 步骤2: 本地计算                                          │
├─────────────────────────────────────────────────────────┤
│ Party 0 计算:                                            │
│   local₀ = x₀×y₀ + x₀×y₁ + x₁×y₀ + r₀                  │
│          = 3×7 + 3×5 + 2×7 + r₀                         │
│                                                          │
│ Party 1 计算:                                            │
│   local₁ = x₁×y₁ + x₁×y₂ + x₂×y₁ + r₁                  │
│                                                          │
│ Party 2 计算:                                            │
│   local₂ = x₂×y₂ + x₂×y₀ + x₀×y₂ + r₂                  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 步骤3: 通信（交换份额）                                  │
├─────────────────────────────────────────────────────────┤
│ Party 0 → Party 1: local₀                               │
│ Party 1 → Party 2: local₁                               │
│ Party 2 → Party 0: local₂                               │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 步骤4: 结果                                              │
├─────────────────────────────────────────────────────────┤
│ Party 0: (z₀, z₁) = (local₀, local₂)                   │
│ Party 1: (z₁, z₂) = (local₁, local₀)                   │
│ Party 2: (z₂, z₀) = (local₂, local₁)                   │
│                                                          │
│ 验证: z₀+z₁+z₂ = 200 ✓                                  │
└─────────────────────────────────────────────────────────┘
```

---

## 4. 项目架构层次

```
┌─────────────────────────────────────────────────────────┐
│                    应用层 (Application)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 医疗数据查询 │  │ 能源数据查询 │  │ 云计算查询   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│              关系层 (Relational Layer)                   │
│  ┌──────────────────────────────────────────────────┐   │
│  │ EncodedTable: 表操作 (sort, join, aggregate)    │   │
│  │ EncodedColumn: 列操作                            │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│               操作符层 (Operators Layer)                 │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐          │
│  │ 排序操作   │ │ 聚合操作   │ │ 流式操作   │          │
│  └────────────┘ └────────────┘ └────────────┘          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│              容器层 (Container Layer)                    │
│  ┌──────────────────┐  ┌──────────────────┐            │
│  │ ASharedVector    │  │ BSharedVector    │            │
│  │ (算术共享向量)   │  │ (布尔共享向量)   │            │
│  └──────────────────┘  └──────────────────┘            │
│  ┌──────────────────┐  ┌──────────────────┐            │
│  │ Vector           │  │ EVector          │            │
│  │ (明文向量)       │  │ (编码向量)       │            │
│  └──────────────────┘  └──────────────────┘            │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│               协议层 (Protocol Layer)                    │
│  ┌──────────────────┐  ┌──────────────────┐            │
│  │ Replicated_3PC   │  │ Fantastic_4PC    │            │
│  │ (半诚实3方)      │  │ (恶意安全4方)    │            │
│  └──────────────────┘  └──────────────────┘            │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│            基础设施层 (Infrastructure Layer)             │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐          │
│  │ 通信模块   │ │ 随机数生成 │ │ 运行时系统 │          │
│  │ (MPI)      │ │ (libsodium)│ │ (多线程)   │          │
│  └────────────┘ └────────────┘ └────────────┘          │
└─────────────────────────────────────────────────────────┘
```

---

## 5. 数据流示例

### 5.1 医疗查询数据流

```
输入数据 (明文)
┌──────────┬──────────┬─────────┬──────────┐
│ 患者ID   │ 时间戳   │ 血糖值  │ 胰岛素   │
├──────────┼──────────┼─────────┼──────────┤
│   101    │   1000   │   120   │    5     │
│   101    │   1100   │   150   │    8     │
│   102    │   1000   │   110   │    3     │
└──────────┴──────────┴─────────┴──────────┘
         ↓ secret_share()
秘密共享数据
┌──────────┬──────────┬─────────┬──────────┐
│ [ID]ᵦ    │ [时间]ᵦ  │ [血糖]ᵦ │ [胰岛素]ₐ│
└──────────┴──────────┴─────────┴──────────┘
         ↓ sort()
排序后
┌──────────┬──────────┬─────────┬──────────┐
│ [ID]ᵦ    │ [时间]ᵦ  │ [血糖]ᵦ │ [胰岛素]ₐ│
│ (按ID和时间排序)                          │
└──────────┴──────────┴─────────┴──────────┘
         ↓ threshold_session_window()
添加窗口ID
┌──────────┬──────────┬─────────┬──────────┬──────────┐
│ [ID]ᵦ    │ [时间]ᵦ  │ [血糖]ᵦ │ [胰岛素]ₐ│ [窗口]ᵦ  │
└──────────┴──────────┴─────────┴──────────┴──────────┘
         ↓ odd_even_aggregation()
聚合结果
┌──────────┬──────────┬──────────┐
│ [ID]ᵦ    │ [窗口]ᵦ  │ [总量]ₐ  │
└──────────┴──────────┴──────────┘
         ↓ open()
最终结果 (明文)
┌──────────┬──────────┬──────────┐
│ 患者ID   │ 窗口ID   │ 总胰岛素 │
├──────────┼──────────┼──────────┤
│   101    │    1     │    13    │
│   102    │    1     │     3    │
└──────────┴──────────┴──────────┘
```

---

## 6. 通信模式

### 6.1 点对点通信（乘法）

```
时间 t=0: 本地计算
┌─────────┐     ┌─────────┐     ┌─────────┐
│ Party 0 │     │ Party 1 │     │ Party 2 │
│ local₀  │     │ local₁  │     │ local₂  │
└─────────┘     └─────────┘     └─────────┘

时间 t=1: 交换份额
┌─────────┐     ┌─────────┐     ┌─────────┐
│ Party 0 │────→│ Party 1 │────→│ Party 2 │
│         │←────│         │←────│         │
└─────────┘     └─────────┘     └─────────┘
    ↑                                 │
    └─────────────────────────────────┘

通信复杂度: O(n) - 每方发送n个元素
通信轮次: 1轮
```

### 6.2 广播通信（打开秘密）

```
时间 t=0: 每方持有份额
┌─────────┐     ┌─────────┐     ┌─────────┐
│ Party 0 │     │ Party 1 │     │ Party 2 │
│ (z₀,z₁) │     │ (z₁,z₂) │     │ (z₂,z₀) │
└─────────┘     └─────────┘     └─────────┘

时间 t=1: 广播缺失的份额
┌─────────┐     ┌─────────┐     ┌─────────┐
│ Party 0 │────→│ Party 1 │────→│ Party 2 │
│ 发送 z₀ │     │ 发送 z₁ │     │ 发送 z₂ │
└─────────┘     └─────────┘     └─────────┘
    ↓               ↓               ↓
所有方重构: z = z₀ + z₁ + z₂

通信复杂度: O(n) - 每方广播n个元素
通信轮次: 1轮
```

---

## 7. 性能特征对比

```
操作类型          │ 算术共享 │ 布尔共享 │ 通信轮次
─────────────────┼──────────┼──────────┼─────────
加法 (a+b)       │    ✓✓    │    ✗     │   0
减法 (a-b)       │    ✓✓    │    ✗     │   0
乘法 (a×b)       │    ✓     │    ✗     │   1
除法 (a÷c)       │    ✓     │    ✗     │   1
─────────────────┼──────────┼──────────┼─────────
AND (a∧b)        │    ✗     │    ✓     │   1
XOR (a⊕b)        │    ✗     │    ✓✓    │   0
NOT (~a)         │    ✗     │    ✓✓    │   0
─────────────────┼──────────┼──────────┼─────────
比较 (a>b)       │    ✗     │    ✓     │  O(log)
等于 (a==b)      │    ✗     │    ✓     │  O(log)
─────────────────┼──────────┼──────────┼─────────
a2b 转换         │    -     │    -     │  O(log)
b2a 转换         │    -     │    -     │   1

✓✓ = 本地操作，无通信
✓  = 需要通信，但高效
✗  = 不支持或效率低
```

---

**提示**: 这些图解配合详细文档阅读效果更佳！

